# 心颖精割——基于飞桨的Heart—DualSeg及瘢痕检测智能诊疗平台 
 
# 项目说明


<font size="4">由于AIStudio平台Notebook生成版本限制了文件上传大小，因此我们将<span style="color:red;">各个模块放在了三个版本中</span>，大家可以在如图所示选择相应版本进行查看。然后由于项目内部只能部署一个模型，在使用“独占本机”的方式部署了基于多尺度子网络级联配准的心脏 MRI 分割后，另外两个模型我们通过整合模型的训练包并写相应的执行脚本部署模型产线的方式上线飞桨返回API进行调用。</font>


![](https://ai-studio-static-online.cdn.bcebos.com/b8db0cafc5c34dc7a871624e45336cce301960ea806d45c9bf72d03c26813003)


# 选题说明


## 项目背景

社会因素上看，心血管疾病是全球第一大致死疾病(CVD)， 它已经成为全球面临的主要健康问题之一， 每年因心血管疾病死亡的人数远多于任何其他疾病死亡人数。根据最近最新发布的《中国心血管健康与疾病报告 2023》，自 1990 年以来，有 CVD 危险因素的人群巨大，加之人口老龄化加速，CVD 仍是我国居民健康的最大威胁之一。

政治经济因素上看，国家对人工智能和医疗健康领域十分重视，比如《新一代人工智能发展规划》（2017年发布）明确了中国在2030年成为全球AI领导者的目标；此外，2024年深化医疗改革的任务中也提到了通过AI技术改善医疗诊断和治疗效率的目标。这些政策为AI在医疗健康领域的创新应用提供了良好的政策环境。

<div style="text-align: center;">
    <img src="https://cdn.jsdelivr.net/gh/JJzbkn/Picture-Host@master/uPic/image-20240928132719208.png" alt="image-20240928132719208" style="width:40%;" />
</div>

从技术因素上看，尽管近年来我国心血管领域的研究呈现蓬勃发展势头，数量与质量都不断提升。然而在心脏疾病的临床诊断上仍有许多不足与困难需要完善和解决的。如上图所示，心脏疾病诊断方法的准确性受主观因素影响大，成像上在很大程度上依赖于操作人员的技术水平，而诊断中医生的技术经验也十分重要，一些经验不足可能影响心脏疾病的早期发现和诊断。同时，在心脏疾病诊断中，不同患者个体化差异明显，出现症状非典型性，这对医生在诊断上也提出了不小的挑战。除此之外，心脏疾病的诊断仍有许多不足与困难亟待解决，如跨科室跨医院等在数据信息整合上的缺陷、时间与金钱成本高等问题。

在心脏瘢痕的检测上同样存在着一些不足和挑战。瘢痕检测需要专门的影像工具，比如心脏磁共振成像（CMR）中的晚期钆增强（LGE）技术，才能准确显示纤维化区域，但 LGE-CMR等先进影像技术的高成本，使得许多医院或诊所难以普及，这意味着大部分患者可能无法获得这一重要的诊断信息。

目前在心脏影像分析领域，已经有大量的研究工作结合了心脏分割与病灶检测（包括瘢痕、肿瘤、梗死区域等）。例如，近年来的论文中提出了许多基于深度学习的双重任务模型，可以同时处理分割和病灶检测任务。此外，心脏影像的三维重建技术使得分割和瘢痕检测可以同时在多维数据上进行，进一步提升了检测的准确性。

## 市场调研

心血管疾病的高发病率和高致死率，使得心脏疾病的诊断和治疗市场需求巨大。随着人口老龄化的加剧，相关患者数量持续增长，对高效、精准的诊断工具需求迫切。然而目前市场上能够同时实现心脏全自动分割和瘢痕检测的相关的一体化平台较少。

本项目开发的基于飞桨深度学习技术的智能诊疗平台，填补了这一市场空白。根据市场调研，全球医疗影像分析市场规模正以每年约8%的速度增长，预计在未来几年内将达到数百亿美元。随着医疗信息化和智能化的推进，该平台具有广阔的应用前景和市场潜力。

| 企业                          | 国家   | 领域                   | 成果                                                         |
| ----------------------------- | ------ | ---------------------- | ------------------------------------------------------------ |
| Arterys                       | 美国   | 云端AI医学影像分析平台 | 提供基于AI的心脏MRI分析工具，可自动进行心脏结构分割和功能分析，加快诊断流程。 |
| HeartFlow                     | 美国   | 心血管疾病诊断AI平台   | 开发基于CT影像的冠状动脉血流分析，提供非侵入性的心脏功能评估工具。 |
| Circle Cardiovascular Imaging | 加拿大 | 心脏影像分析软件       | 提供先进的CMR和CT影像分析工具，包括心肌瘢痕定量分析，广泛应用于临床和研究。 |
| Zebra Medical Vision          | 以色列 | 医学影像AI诊断平台     | 开发多种AI算法，包括用于心脏疾病的自动检测和分割，提高放射科医生的工作效率。 |
| Medis Medical Imaging Systems | 荷兰   | 心血管影像分析软件     | 提供心脏CT和MRI影像分析工具，包括瘢痕组织的检测和定量分析。  |

如上表所示，国外在基于人工智能的心脏疾病诊疗平台方面已经有了深入的研究和实际应用，而国内在这方面仍有较大的发展空间和迫切的市场需求，本项目紧跟国际前沿，贴合了国内市场趋势，推动国内医疗技术的创新和提升，满足临床诊疗的实际需求。

# 作品内容


## 功能架构图与流程概述

本项目的核心技术体系通过三大模块紧密结合，形成从全心脏结构分割到局部关键区域分割再到心肌纤维化瘢痕检测的完整诊疗流程。

<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/4415baff8aeb48abb1b5d561f580af6e49a22d5ba64744b4b6f544c3d0560050" style="width:50%;" />
</div>


首先，利用基于3D-Unet的多模态全心脏分割算法，根据患者心脏的完整影像，自动分割出心脏的各大解剖结构，包括左心室、右心室、心房等多个重要部位，为医生提供全面的心脏解剖信息，适合在需要整体结构分析时使用。其次，基于多尺度子网络级联配准的单样本分割算法，侧重于解决在大尺度形变的影像情况下的精确分割问题。该算法通过将多个子网络进行级联整合，增强了模型在处理大尺度心脏形变时的学习和理解能力，特别适用于精准分割左心室、右心室和心肌等关键部位，同时对于部分病例中数据量较少或数据类型单一的情况，能确保在单样本条件下依然能够实现高精度的分割，保障诊疗信息的全面性。最后，在此基础上，平台通过基于飞桨的MedicalSeg-Vnet的心脏瘢痕检测模块，进行心肌纤维化瘢痕的定量检测，结合前面的分割数据，为医生提供精细的病灶信息，辅助医生制定个性化的治疗方案，同时利用文心ERINE BOT综合以上结果生成诊疗报告。三个模块紧密结合，不仅提高了诊断的效率和准确性，还为不同病情和数据条件的患者提供灵活而精准的诊疗支持。

## 平台功能与技术框架

该网页平台如图所示，采用了SpringBoot和Vue 3作为开发框架，并使用MyBatis与MySQL作为后端数据库管理系统。为确保用户隐私安全，平台通过MD5对用户密码进行加密处理，同时利用JWT令牌存储用户ID，确保安全的登录和会话管理。此外，平台参考SAM大模型的DEMO设计，构建了用于2D图像切割展示的页面，并通过NiiVue插件实现了3D图像展示。结合JsPdf与Html2Canvas技术，以及文心一言插件，平台提供了辅助诊断和医疗报告的生成与下载功能。为了更好地促进医生与患者之间的沟通，平台还设置了在线辅助诊疗系统，方便医生为患者上传心脏NIfTI图像并添加评语。

用户上传的影像数据，包括图片和NIFTI格式的心脏影像，存储在阿里云OSS对象存储服务中，确保数据的安全性与持久性。项目模型部署在AutoDL和AIStudio服务器上，使用Flask微服务架构创建API接口，实现模型推理服务化。前端传输的影像数据经过实时推理，返回心脏分割和瘢痕检测结果。

## 数据获取及预处理

本项目的**数据获取**主要来源于2017年MICCAI举办的多模态全心脏分割挑战赛的数据集MM-WHS，该数据集包含60个CT图像和60个MR图像，以及心脏自动诊断挑战赛ACDC的数据集，并基于它的bSSFP序列完成训练的。心肌瘢痕检测模型采用了来自LAScarQS2022挑战赛提供的在真实临床环境中从患有心房颤动 (AF) 的患者身上采集的 194 (+) 个 LGE MRI进行训练。

<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/6330162d299744059e2d7820a0a66fc9e862728f20d345aa8e77e0f008f40769" style="width:67%;" />
</div>


在**数据预处理**部分，多模态心脏分割模块主要采用对比度限制自适应直方图均衡化（CLAHE）技术来增强图像质量和对比度，从而提高后续分割算法的性能。在基于多尺度子网络级联配准的分割模块，设计了一种心脏MRI特定的初始刚性配准方法，以对齐不同图像中的心脏结构，大致步骤包括多尺度掩膜构建、目标图像二值化、预配准、亮度一致性调整和图像裁剪。而心脏瘢痕检测模块采用归一化与随机增强方法。

## 基于3D-Unet的多模态全心脏影像分割算法

全心脏分割模块采用了改进的3D U-Net架构，通过3D卷积操作捕捉更丰富的空间信息并提高分割精度。跳跃连接保留了低层次特征，增强了对细节的捕捉能力。我们通过迁移学习和深度监督机制改进了FCN模型，迁移学习使用预训练的C3D模型初始化下采样路径，深度监督机制通过多层次的侧路径增强梯度流，解决梯度消失问题并提升分割性能。分层深度监督确保网络有效学习到不同层次的语义信息。

<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/6d04cd102334426f9ad0a2cc0f663e67d7476646c6ff40f88fcc5b091174e9f3" style="width:67%;" />
</div>


推理结果如下图所示：
<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/38a0114c8848423d9f6764b000ffe677c19cb6aee73f4232b1199a2f2bff081d" style="width:67%;" />
</div>


## 基于多尺度子网络级联配准的心脏 MRI 单样本分割

本模块构建了一个端到端的多子网络级联模型，专门应对心脏尺寸差异，采用可形变配准网络来增强模型处理大尺度形变的能力。通过级联不同尺度输入的子网络，实现了心脏MRI图像的单样本分割，减少了对标记数据的依赖，充分利用无标记数据，并能够精确分割左心室和心肌等关键部位，即使在大尺度形变的情况下也能表现良好。

<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/111954d84112498d814379c9e0a3b88eb8446fb20ee34bc0bb9ec25ae971bd78" style="width:50%;" />
</div>


整体框架通过多尺度图像金字塔结构，结合大核卷积层和双分支孪生网络架构，增大感受野并强化特征关联学习。随着级联子网络层数的增加，输入逐渐恢复至原始尺度，实现对局部形变的学习，逐步完成高精度的分割预测。


推理结果如下图所示：
<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/c4d061d316db4e589bbc51f5adc639dc1c503908dec34391944be914adf500ba" style="width:67%;" />
</div>

## 基于飞桨的MedicalSeg-Vnet的心脏 MRI 心肌瘢痕检测模块

在本项目中，我们小组使用了飞桨提供的PaddleSeg系列中的3D医学影像分割解决方案MedicalSeg，通过MedicalSeg工具集成的Vne模型，完成了对心肌瘢痕的检测与量化。MedicalSeg为3D医学图像分割提供了完整的工作流程支持，包括数据预处理、模型训练和模型部署。

<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/57f7a30c2461476999ef6c69aa48289e624f28b4e11346e2ba184f3417631f4f" style="width:80%;" />
</div>


针对Vnet网络心肌瘢痕检测训练过程：

1）首先进行ROI选取：去除多余背景，提取模型一（基于 3D-Unet 的多模态全心脏影响分割算法）切割出的左心房壁附近区域。然后对左心房Mask分别进行形态学膨胀（核大小是5）和形态学腐蚀（核大小是3），将膨胀结果减去腐蚀结果，再采用最大连通域分析得到左心房壁附近区域ROI结果。然后统计ROI图像的平均图像大小（174，105，38），平均Spacing大小（0.625，0.625，2.5）。

2）然后进行数据预处理：将数据缩放到固定大小为（192x128x64），训练数据中随机选择30例作为验证集，剩下120例为模型训练数据，最后对训练数据进行10倍数据扩充操作（旋转，平移，翻转等操作）。

3）接着进行图像预处理：对图像进行像素大小百分比截断（1，99），再采用z-score方式进行归一化处理，去除异常像素值并标准化图像的像素值。

4）最后搭建Vnet网络训练：按下图的网络架构进行Vnet网络的搭建，在Unet的基础上引入残差块的短路连接：

选取50例作为测试集，使用AdamW优化器，学习率是0.001，batchsize=1，epoch=200，用 Dice loss 作为损失函数，采用Dice系数作为瘢痕检测评价标准，最终得到60%~70%准确度的模型参数。


推理结果如下图所示：
<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/72a56a35abef419ba3dd6862bb6fb1e2f467a2a9e970474cb789a55db11c77d3" style="width:67%;" />
</div>

------

## 网页平台展示

以下依次是用户主页、生成报告、模型分割页面以及三维心脏视图页面。本平台的主页上左侧可以显示用户的一些基本信息，然后中间显示了目前上传的一些影像数据，可以点开进行下一步操作。然后生成报告的页面中，我们左侧有一个文心一言ERINE BOT的一个对话窗口供用户进行对话体验，然后中间有一个由文心一言收集患者基本信息自动生成的一个心脏疾病诊疗报告。在模型分割页面，用户可以点击导航小助手选择用于模型分割的影像数据，然后可以在左侧选择相应功能进行使用。然后是三维心脏视图页面，这个页面我们使用了NiiVue的插件，将分割后的结果进行一个三维可视化，用户可以根据自己需求选择相应选项查看。

<div style="text-align: center;">
    <img src="https://ai-studio-static-online.cdn.bcebos.com/e5e801b526ac4976a59acb793caa61e74c00173defa5427297672f980ec41097" style="width:90%;" />
</div>
